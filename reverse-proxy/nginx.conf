worker_processes auto;


error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;


events { worker_connections 1024; }


http {
include /etc/nginx/mime.types;
default_type application/octet-stream;
sendfile on;
keepalive_timeout 65;


# Proxy upstream hacia API en red edge
upstream api_upstream {
server api:3000;
}


server {
listen 8080;


# Seguridad básica
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "DENY" always;
add_header Referrer-Policy "no-referrer" always;


location /health {
proxy_pass http://api_upstream/health;
proxy_set_header Host $host;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Request-Id $request_id;
}


location /items {
proxy_pass http://api_upstream/items;
proxy_set_header Host $host;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Request-Id $request_id;
}


# Regla por defecto: reenviar / a API
location / {
proxy_pass http://api_upstream/;
proxy_set_header Host $host;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Request-Id $request_id;


# timeouts sensatos
proxy_connect_timeout 3s;
proxy_read_timeout 10s;
}


# 404 explícito para rutas no existentes si upstream falla
error_page 404 /404.json;
location = /404.json { return 404 '{"error":"not found"}'; add_header Content-Type application/json; }
}
}